import { RESTAURANTS } from '@/lib/restaurant-data'

export default function CustomerLifetimeValueKPI() {
  // CUS_008 Customer Lifetime Value (CLV) - Exact specifications from restaurant_kpi_metrics_127.txt
  const clvData = [
    {
      restaurant: RESTAURANTS[0], // Chanakyapuri
      averageSpendPerVisit: 450,
      purchaseFrequencyPerYear: 6.5,
      expectedLifetimeMonths: 18,
      expectedLifetimeYears: 1.5,
      clv: 4388, // 450 √ó 6.5 √ó 1.5
      status: 'warning', // Below target range
      acquisitionChannel: {
        organic: { clv: 5200, percentage: 35 },
        zomato: { clv: 3800, percentage: 40 },
        instagram: { clv: 4600, percentage: 15 },
        referral: { clv: 6100, percentage: 10 }
      },
      monthlyTrends: {
        jan: 4100, feb: 4200, mar: 4400, apr: 4500, may: 4300, jun: 4400
      }
    },
    {
      restaurant: RESTAURANTS[1], // Gurugram
      averageSpendPerVisit: 520,
      purchaseFrequencyPerYear: 8.2,
      expectedLifetimeMonths: 24,
      expectedLifetimeYears: 2.0,
      clv: 8528, // 520 √ó 8.2 √ó 2.0
      status: 'good', // Within target range
      acquisitionChannel: {
        organic: { clv: 9800, percentage: 45 },
        zomato: { clv: 7200, percentage: 30 },
        instagram: { clv: 8900, percentage: 15 },
        referral: { clv: 10500, percentage: 10 }
      },
      monthlyTrends: {
        jan: 8000, feb: 8200, mar: 8400, apr: 8600, may: 8500, jun: 8528
      }
    },
    {
      restaurant: RESTAURANTS[2], // Shahpur Jat
      averageSpendPerVisit: 380,
      purchaseFrequencyPerYear: 4.8,
      expectedLifetimeMonths: 15,
      expectedLifetimeYears: 1.25,
      clv: 2280, // 380 √ó 4.8 √ó 1.25
      status: 'critical', // Below warning range
      acquisitionChannel: {
        organic: { clv: 2800, percentage: 25 },
        zomato: { clv: 2100, percentage: 50 },
        instagram: { clv: 2400, percentage: 20 },
        referral: { clv: 2900, percentage: 5 }
      },
      monthlyTrends: {
        jan: 2500, feb: 2400, mar: 2350, apr: 2300, may: 2250, jun: 2280
      }
    }
  ]

  const chainTotalClv = clvData.reduce((sum, item) => sum + item.clv, 0) / clvData.length
  const chainTotalSpend = clvData.reduce((sum, item) => sum + item.averageSpendPerVisit, 0) / clvData.length
  const chainAvgFrequency = clvData.reduce((sum, item) => sum + item.purchaseFrequencyPerYear, 0) / clvData.length

  const getStatusColor = (clv: number) => {
    if (clv >= 5000) return 'text-green-600'
    if (clv >= 2000) return 'text-yellow-600'
    return 'text-red-600'
  }

  const getStatusBg = (clv: number) => {
    if (clv >= 5000) return 'bg-green-50 dark:bg-green-900/20 border-green-200'
    if (clv >= 2000) return 'bg-yellow-50 dark:bg-yellow-900/20 border-yellow-200'
    return 'bg-red-50 dark:bg-red-900/20 border-red-200'
  }

  const getStatusIcon = (clv: number) => {
    if (clv >= 5000) return 'diamond'
    if (clv >= 2000) return 'alert'
    return 'warning'
  }

  return (
    <div className="space-y-6">
      {/* Header with KPI ID */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-xs font-bold text-black dark:text-white">
            Customer Lifetime Value (CLV)
          </h1>
          <p className="text-xs font-normal text-gray-500 mt-1">
            KPI ID: CUS_008 | Total Profit Expected from Customer Over Lifetime
          </p>
        </div>
      </div>

      {/* Definition & Formula Card */}
      <div className="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg border border-blue-200">
        <h2 className="text-xs font-bold text-blue-900 dark:text-blue-300 mb-2">
          üìä Definition & Formula
        </h2>
        <div className="space-y-2">
          <p className="text-xs font-normal text-blue-800 dark:text-blue-300">
            <strong>Formula:</strong> Average Spend per Visit √ó Purchase Frequency (per year) √ó Expected Customer Lifetime (months √∑ 12)
          </p>
          <p className="text-xs font-normal text-blue-800 dark:text-blue-300">
            <strong>Definition:</strong> Total profit expected from a customer over their lifetime. Compare CLV across acquisition channels to optimize marketing.
          </p>
          <p className="text-xs font-normal text-blue-800 dark:text-blue-300">
            <strong>Why Critical:</strong> Channels with high CLV justify higher CAC; informs marketing budget allocation and retention strategy.
          </p>
        </div>
      </div>

      {/* Alert Thresholds */}
      <div className="bg-card p-4 rounded-lg border">
        <h2 className="text-xs font-bold text-black dark:text-white mb-4">
          üéØ Target Ranges & Alert Thresholds
        </h2>
        <div className="grid grid-cols-3 gap-4">
          <div className="text-center p-3 bg-green-50 dark:bg-green-900/20 rounded border border-green-200">
            <div className="text-xs font-bold text-green-700 dark:text-green-300">TARGET</div>
            <div className="text-xs font-normal text-green-600">‚Çπ5,000‚Äì‚Çπ15,000 per customer</div>
          </div>
          <div className="text-center p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded border border-yellow-200">
            <div className="text-xs font-bold text-yellow-700 dark:text-yellow-300">WARNING</div>
            <div className="text-xs font-normal text-yellow-600">‚Çπ2,000‚Äì‚Çπ5,000 (declining)</div>
          </div>
          <div className="text-center p-3 bg-red-50 dark:bg-red-900/20 rounded border border-red-200">
            <div className="text-xs font-bold text-red-700 dark:text-red-300">CRITICAL</div>
            <div className="text-xs font-normal text-red-600"><‚Çπ2,000</div>
          </div>
        </div>
      </div>

      {/* Chain Summary */}
      <div className="bg-card p-4 rounded-lg border">
        <h2 className="text-xs font-bold text-black dark:text-white mb-4">
          üìà Chain Performance Summary
        </h2>
        <div className="grid grid-cols-3 gap-6">
          <div>
            <span className="text-xs font-normal text-gray-500">Average CLV</span>
            <div className="flex items-center gap-2">
              <span className="text-xs font-bold text-black dark:text-white">
                ‚Çπ{chainTotalClv.toLocaleString('en-IN', { maximumFractionDigits: 0 })}
              </span>
              <span>üí∞</span>
            </div>
          </div>
          <div>
            <span className="text-xs font-normal text-gray-500">Avg Spend/Visit</span>
            <div className="flex items-center gap-2">
              <span className="text-xs font-bold text-black dark:text-white">
                ‚Çπ{chainTotalSpend.toLocaleString('en-IN', { maximumFractionDigits: 0 })}
              </span>
              <span>üõí</span>
            </div>
          </div>
          <div>
            <span className="text-xs font-normal text-gray-500">Avg Frequency/Year</span>
            <div className="flex items-center gap-2">
              <span className="text-xs font-bold text-black dark:text-white">
                {chainAvgFrequency.toFixed(1)}
              </span>
              <span>üîÑ</span>
            </div>
          </div>
        </div>
      </div>

      {/* Location Performance */}
      <div className="bg-card p-4 rounded-lg border">
        <h2 className="text-xs font-bold text-black dark:text-white mb-4">
          üèÜ Location Performance (CLV Analysis)
        </h2>
        <div className="space-y-3">
          {clvData
            .sort((a, b) => b.clv - a.clv)
            .map((location, index) => (
            <div key={location.restaurant.id} className={`p-3 rounded border ${getStatusBg(location.clv)}`}>
              <div className="flex items-center justify-between mb-2">
                <div className="flex items-center gap-3">
                  <span className="text-xs font-normal text-gray-500">#{index + 1}</span>
                  <span className="text-xs font-bold text-black dark:text-white">
                    {location.restaurant.fullName}
                  </span>
                  <span>{getStatusIcon(location.clv)}</span>
                </div>
                <div className="text-right">
                  <div className="text-xs font-bold text-black dark:text-white">
                    ‚Çπ{location.clv.toLocaleString('en-IN')} CLV
                  </div>
                  <div className="text-xs font-normal text-gray-500">
                    {location.expectedLifetimeYears}yr lifetime
                  </div>
                </div>
              </div>
              
              {/* CLV components */}
              <div className="grid grid-cols-3 gap-4 mb-3">
                <div className="text-center">
                  <div className="text-xs font-normal text-gray-500">Spend/Visit</div>
                  <div className="text-xs font-bold text-black dark:text-white">
                    ‚Çπ{location.averageSpendPerVisit}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-xs font-normal text-gray-500">Frequency/Year</div>
                  <div className="text-xs font-bold text-black dark:text-white">
                    {location.purchaseFrequencyPerYear}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-xs font-normal text-gray-500">Lifetime (months)</div>
                  <div className="text-xs font-bold text-black dark:text-white">
                    {location.expectedLifetimeMonths}
                  </div>
                </div>
              </div>

              {/* Acquisition channel breakdown */}
              <div className="mt-3">
                <h4 className="text-xs font-bold text-gray-600 mb-2">CLV by Acquisition Channel</h4>
                <div className="grid grid-cols-2 gap-3">
                  <div className="flex justify-between text-xs">
                    <span className="text-gray-500">Organic ({location.acquisitionChannel.organic.percentage}%):</span>
                    <span className="font-normal text-green-600">‚Çπ{location.acquisitionChannel.organic.clv.toLocaleString('en-IN')}</span>
                  </div>
                  <div className="flex justify-between text-xs">
                    <span className="text-gray-500">Zomato ({location.acquisitionChannel.zomato.percentage}%):</span>
                    <span className="font-normal text-blue-600">‚Çπ{location.acquisitionChannel.zomato.clv.toLocaleString('en-IN')}</span>
                  </div>
                  <div className="flex justify-between text-xs">
                    <span className="text-gray-500">Instagram ({location.acquisitionChannel.instagram.percentage}%):</span>
                    <span className="font-normal text-purple-600">‚Çπ{location.acquisitionChannel.instagram.clv.toLocaleString('en-IN')}</span>
                  </div>
                  <div className="flex justify-between text-xs">
                    <span className="text-gray-500">Referral ({location.acquisitionChannel.referral.percentage}%):</span>
                    <span className="font-normal text-orange-600">‚Çπ{location.acquisitionChannel.referral.clv.toLocaleString('en-IN')}</span>
                  </div>
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>

      {/* Data Sources & Refresh */}
      <div className="bg-card p-4 rounded-lg border">
        <h2 className="text-xs font-bold text-black dark:text-white mb-4">
          üîÑ Data Sources & Refresh Schedule
        </h2>
        <div className="grid grid-cols-2 gap-6">
          <div className="space-y-2">
            <h3 className="text-xs font-bold text-black dark:text-white">Data Sources:</h3>
            <ul className="text-xs font-normal text-gray-500 space-y-1">
              <li>‚Ä¢ CRM transaction history</li>
              <li>‚Ä¢ Customer purchase patterns</li>
              <li>‚Ä¢ Acquisition channel tracking</li>
              <li>‚Ä¢ Customer behavior analytics</li>
            </ul>
          </div>
          <div className="space-y-2">
            <h3 className="text-xs font-bold text-black dark:text-white">Refresh Schedule:</h3>
            <ul className="text-xs font-normal text-gray-500 space-y-1">
              <li>‚Ä¢ Monthly CLV calculation</li>
              <li>‚Ä¢ Channel performance review</li>
              <li>‚Ä¢ Alert if CLV drops >20%</li>
              <li>‚Ä¢ Cohort analysis quarterly</li>
            </ul>
          </div>
        </div>
      </div>

      {/* Drill-down Options */}
      <div className="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg border border-purple-200">
        <h2 className="text-xs font-bold text-purple-900 dark:text-purple-300 mb-2">
          üîç Available Drill-downs
        </h2>
        <div className="space-y-1">
          <p className="text-xs font-normal text-purple-800 dark:text-purple-300">
            ‚Ä¢ By acquisition channel performance
          </p>
          <p className="text-xs font-normal text-purple-800 dark:text-purple-300">
            ‚Ä¢ Customer cohort analysis (monthly/quarterly)
          </p>
          <p className="text-xs font-normal text-purple-800 dark:text-purple-300">
            ‚Ä¢ CLV vs CAC analysis by channel
          </p>
          <p className="text-xs font-normal text-purple-800 dark:text-purple-300">
            ‚Ä¢ Customer segment breakdown
          </p>
        </div>
      </div>

      {/* Users & Access */}
      <div className="bg-gray-50 dark:bg-gray-900/20 p-4 rounded-lg border border-gray-200">
        <h2 className="text-xs font-bold text-black dark:text-white mb-2">
          üë• Authorized Users
        </h2>
        <p className="text-xs font-normal text-gray-500">
          Marketing Manager, Finance Manager, General Manager
        </p>
      </div>
    </div>
  )
}